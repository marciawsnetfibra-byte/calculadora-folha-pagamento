<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Adicionais e Reflexos da Folha de Pagamento</title>
    
    <!-- Firebase SDK Versão Compatível -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Define a cor principal para os títulos (CANVA #1800AD) */
        :root {
            --cor-titulo: #1800AD;
            --cor-menu: #1800AD;
            --cor-menu-hover: #0d0066;
        }
        .titulo-cor {
            color: var(--cor-titulo) !important;
        }

        /* Menu Horizontal */
        .main-menu {
            background-color: var(--cor-menu);
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .menu-container {
            max-width: 1100px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-logo {
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }
        
        .menu-logo i {
            margin-right: 8px;
        }
        
        .menu-items {
            display: flex;
            gap: 1rem;
        }
        
        .menu-button {
            background-color: transparent;
            color: white;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .menu-button.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f9fafb;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--cor-titulo);
            font-size: 1.25rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .modal-close:hover {
            color: #374151;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        /* Estilos básicos para o container */
        .container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Garantindo uniformidade visual de altura e largura em todos os campos */
        input[type="text"], input[type="number"], select, input[type="month"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            height: 40px !important;
            line-height: normal;
        }
        
        /* Estilização dos botões discretos */
        #printButton, #clearButton, #saveButton, #loadDataButton, #exportDataButton {
            color: var(--cor-titulo);
            border: 1px solid transparent;
            margin-left: 10px;
        }
        #printButton:hover, #clearButton:hover, #saveButton:hover, #loadDataButton:hover, #exportDataButton:hover {
             border: 1px solid var(--cor-titulo);
             background-color: #f0f4ff;
        }

        /* Estilos para a seção de salvamento */
        .save-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .collaborator-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            margin-top: 10px;
        }
        
        .collaborator-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .collaborator-item:hover {
            background-color: #f0f4ff;
        }
        
        .collaborator-item:last-child {
            border-bottom: none;
        }
        
        .collaborator-name {
            font-weight: 600;
            color: var(--cor-titulo);
        }
        
        .collaborator-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .delete-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .delete-btn:hover {
            background-color: #fee2e2;
        }
        
        /* Tabela de colaboradores, departamentos e histórico */
        .collaborator-table, .department-table, .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .collaborator-table th, .department-table th, .history-table th {
            background-color: #f3f4f6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .collaborator-table td, .department-table td, .history-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .collaborator-table tr:hover, .department-table tr:hover, .history-table tr:hover {
            background-color: #f9fafb;
        }
        
        .department-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Estilos para impressão */
        @media print {
            .print-hide, .container > .header-with-logo, .container > h1, 
            .save-section, #employeeNameInput, #saveButton, #loadDataButton, 
            #exportDataButton, .collaborator-section, .main-menu,
            .department-section, .history-section, .modal,
            .toggle-bases-btn, .status-toggle-buttons {
                display: none !important;
            }

            body, .container {
                margin: 0;
                padding: 0;
                box-shadow: none;
                width: 100%;
                background-color: #fff;
            }

            .container > .grid {
                grid-template-columns: 1fr 1fr; 
                gap: 20px;
            }

             /* ESTILIZAÇÃO DOS INPUTS NO MODO IMPRESSÃO */
             #input-container input, #input-container select {
                border: none !important;
                background-color: transparent !important;
                padding: 0 !important;
                height: auto !important;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                font-weight: bold;
                text-align: left !important;
             }
             
             #input-container label {
                font-weight: bold;
                margin-right: 5px;
                display: inline-block;
                width: 100%;
                color: #374151;
             }

             #input-container > div > .border-b {
                background-color: #e0e7ff;
                padding: 5px;
                margin-bottom: 5px;
             }
             
             #input-container .text-xs, #input-container input[type="checkbox"], #input-container .flex.items-center {
                display: none !important;
             }
             
             #valorPericulosidadeInputDisplay {
                display: block !important;
                font-size: 0.875rem;
                font-weight: 600;
             }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .menu-items {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .menu-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .container {
                margin: 20px auto;
                padding: 15px;
            }
        }
        
        /* Botões de status na aba colaboradores */
        .status-toggle-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        
        .status-toggle-btn {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .status-toggle-btn.active {
            background-color: var(--cor-titulo);
            color: white;
            border-color: var(--cor-titulo);
        }
        
        .status-toggle-btn:not(.active) {
            background-color: white;
            color: var(--cor-titulo);
            border-color: #d1d5db;
        }
        
        .status-toggle-btn:not(.active):hover {
            background-color: #f0f4ff;
        }
        
        /* Nova classe para destacar a mudança */
        .info-box {
            background-color: #e0f2fe;
            border-left: 4px solid #0369a1;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
        }
        
        .info-box strong {
            color: #0369a1;
        }
        
        /* Estilo para destacar o campo de feriados */
        .holidays-field-container {
            position: relative;
        }
        
        .holidays-field-container input {
            padding-right: 10px;
        }
        
        /* NOVOS ESTILOS PARA FIREBASE */
        .firebase-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .firebase-connected {
            background-color: #10B981;
            color: white;
        }
        
        .firebase-disconnected {
            background-color: #EF4444;
            color: white;
        }
        
        .firebase-loading {
            background-color: #F59E0B;
            color: white;
        }
        
        .firebase-offline {
            background-color: #6B7280;
            color: white;
        }
        
        /* Modal de login */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .login-tabs {
            display: flex;
            gap: 1px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        .login-tab.active {
            background-color: var(--cor-titulo);
            color: white;
        }
        
        .sync-badge {
            background-color: #3B82F6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 14px;
            margin-left: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <!-- Status do Firebase -->
    <div id="firebaseStatus" class="firebase-status firebase-loading">
        <i class="fas fa-sync fa-spin"></i>
        <span>Conectando ao banco de dados...</span>
    </div>

    <!-- Modal de Login -->
    <div id="loginModal" class="login-modal" style="display: none;">
        <div class="login-box">
            <h2 class="text-2xl font-bold titulo-cor mb-2">Acesso ao Sistema</h2>
            <p class="mb-6 text-gray-600 text-sm">Faça login para sincronizar seus dados na nuvem</p>
            
            <div class="login-tabs">
                <button class="login-tab active" id="tabLogin">Entrar</button>
                <button class="login-tab" id="tabSignup">Cadastrar</button>
            </div>
            
            <div id="loginError" class="text-red-500 text-sm mb-4 hidden p-3 bg-red-50 rounded">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- Formulário de Login -->
            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="seu@email.com" autocomplete="username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="current-password">
                    </div>
                    
                    <button id="btnLogin" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition duration-150">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </div>
            </div>
            
            <!-- Formulário de Cadastro -->
            <div id="signupForm" style="display: none;">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signupEmail" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="seu@email.com" autocomplete="username">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha (mínimo 6 caracteres)</label>
                        <input type="password" id="signupPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="new-password">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                        <input type="password" id="signupConfirmPassword" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                               placeholder="••••••••" autocomplete="new-password">
                    </div>
                    
                    <button id="btnSignup" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium transition duration-150">
                        <i class="fas fa-user-plus mr-2"></i>Criar Conta
                    </button>
                </div>
            </div>
            
            <div class="mt-6 pt-6 border-t text-center">
                <button id="btnContinueOffline" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-laptop mr-1"></i>Continuar sem login (apenas local)
                </button>
            </div>
            
            <div class="mt-4 text-xs text-gray-500">
                <p><i class="fas fa-info-circle mr-1"></i> Com login, seus dados serão salvos na nuvem e poderão ser acessados de qualquer dispositivo.</p>
            </div>
        </div>
    </div>

    <!-- MENU HORIZONTAL -->
    <nav class="main-menu print-hide">
        <div class="menu-container">
            <div class="menu-logo">
                <i class="fas fa-calculator"></i>
                <span>Folha de Pagamento</span>
                <div id="userInfo" class="user-info" style="display: none;">
                    <i class="fas fa-user-circle"></i>
                    <span id="userEmail"></span>
                </div>
            </div>
            <div class="menu-items">
                <button class="menu-button active" id="menuCalculator">
                    <i class="fas fa-calculator"></i> Calculadora
                </button>
                <button class="menu-button" id="menuCollaborators">
                    <i class="fas fa-users"></i> Colaboradores
                </button>
                <button class="menu-button" id="menuDepartments">
                    <i class="fas fa-building"></i> Departamentos
                </button>
                <button class="menu-button" id="menuHistory">
                    <i class="fas fa-history"></i> Histórico
                </button>
                <button class="menu-button" id="btnLogout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
    </nav>

    <!-- MODAL DE CADASTRO DE COLABORADOR -->
    <div class="modal" id="collaboratorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="collaboratorModalTitle">Cadastrar Novo Colaborador</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collaboratorForm">
                    <input type="hidden" id="collaboratorEditId">
                    <div class="space-y-4">
                        <div>
                            <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-1">
                                Nome Completo *
                            </label>
                            <input type="text" id="collaboratorName" required class="w-full" placeholder="Ex: João da Silva">
                        </div>
                        
                        <div>
                            <label for="collaboratorDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                                Departamento *
                            </label>
                            <select id="collaboratorDepartment" required class="w-full">
                                <option value="">Selecione...</option>
                                <!-- Departamentos serão carregados dinamicamente -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="collaboratorBaseSalary" class="block text-sm font-medium text-gray-700 mb-1">
                                Salário Base (R$) *
                            </label>
                            <input type="text" id="collaboratorBaseSalary" required class="w-full" placeholder="Ex: 2.500,00">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="collaboratorDivisor" class="block text-sm font-medium text-gray-700 mb-1">
                                    Horas Mensais *
                                </label>
                                <select id="collaboratorDivisor" required class="w-full">
                                    <option value="220">220 horas (Padrão)</option>
                                    <option value="180">180 horas</option>
                                    <option value="170">170 horas (Reduzido)</option>
                                    <option value="200">200 horas</option>
                                </select>
                            </div>
                            <div>
                                <label for="collaboratorWorkHours" class="block text-sm font-medium text-gray-700 mb-1">
                                    Jornada Diária
                                </label>
                                <select id="collaboratorWorkHours" class="w-full">
                                    <option value="8">8 horas</option>
                                    <option value="6">6 horas</option>
                                    <option value="4">4 horas</option>
                                    <option value="12">12x36</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorPericulosidade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorPericulosidade" class="text-sm font-medium text-gray-700">
                                    Recebe Periculosidade?
                                </label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="collaboratorInsalubridade" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                                <label for="collaboratorInsalubridade" class="text-sm font-medium text-gray-700">
                                    Recebe Insalubridade?
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelCollaborator" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="collaboratorModalButton">Salvar Colaborador</span>
                            <span id="syncBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE CADASTRO/EDIÇÃO DE DEPARTAMENTO -->
    <div class="modal" id="departmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="departmentModalTitle">Cadastrar Novo Departamento</h3>
                <button class="modal-close" id="closeDepartmentModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="space-y-4">
                        <div>
                            <label for="departmentName" class="block text-sm font-medium text-gray-700 mb-1">
                                Nome do Departamento *
                            </label>
                            <input type="text" id="departmentName" required class="w-full" placeholder="Ex: Produção">
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="departmentActive" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="departmentActive" class="text-sm font-medium text-gray-700">
                                Departamento Ativo
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                        <button type="button" id="cancelDepartment" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <span id="departmentModalButton">Salvar Departamento</span>
                            <span id="syncBadgeDept" class="sync-badge ml-2" style="display: none;">Cloud</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE DETALHES DO CÁLCULO -->
    <div class="modal" id="calculationDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="calculationDetailTitle">Detalhes do Cálculo</h3>
                <button class="modal-close" id="closeCalculationDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="calculationDetailContent">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
                    <button type="button" id="closeCalculationDetail" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50">
                        Fechar
                    </button>
                    <button type="button" id="printCalculationDetail" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-print mr-1"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL (CALCULADORA) -->
    <div class="container" id="calculatorContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            Calculadora de Adicionais e Reflexos da Folha de Pagamento
            <span id="cloudStatusBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <!-- Caixa informativa sobre a nova funcionalidade -->
        <div class="info-box print-hide">
            <strong>IMPORTANTE:</strong> O campo "Dias Normais (Presença)" impacta diretamente o cálculo dos reflexos DSR. 
            <br>O sistema considera apenas os domingos e feriados que ocorrem <strong>após o período trabalhado</strong>.
            <br>Exemplo: Trabalhou apenas 11 dias em janeiro? Apenas os domingos/feriados após o dia 11 serão considerados no cálculo.
        </div>

        <!-- Seletor de Colaborador -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg titulo-cor mb-2">Selecionar Colaborador</h3>
                    <p class="text-sm text-gray-600">Escolha um colaborador cadastrado para preencher os dados automaticamente</p>
                </div>
                <button id="refreshCollaborators" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
            
            <div class="mt-3">
                <select id="collaboratorSelect" class="w-full">
                    <option value="">-- Selecione um colaborador --</option>
                    <!-- Opções serão preenchidas via JavaScript -->
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Coluna de Entradas (Inputs) -->
            <div id="input-container">
                <h2 class="text-xl font-semibold mb-4 titulo-cor">Entradas de Dados</h2>

                <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Salário e Divisor</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="salarioBase" class="block text-sm font-medium text-gray-700">Salário Base (R$)</label>
                            <input type="text" id="salarioBase" value="" class="mt-1" placeholder="Ex: 1.518,00">
                        </div>
                        <div>
                            <label for="divisorMensal" class="block text-sm font-medium text-gray-700">Horas Mensais</label>
                            <select id="divisorMensal" class="mt-1">
                                <option value="220">220 (Padrão)</option>
                                <option value="170">170 (Reduzido)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center mt-4 pt-2 border-t">
                        <input type="checkbox" id="usaPericulosidade" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                        <label for="usaPericulosidade" class="text-sm font-medium text-gray-700">Incluir Adicional de Periculosidade (30%)</label>
                         <span id="valorPericulosidadeInputDisplay" class="ml-auto font-bold titulo-cor">R$ 0,00</span>
                    </div>
                    <p class="text-xs text-gray-500 italic">O valor da Periculosidade é calculado pró-rata (dias trabalhados - atestados).</p>
                </div>
                
                <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Horas de Adicionais</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <label for="horasSobreavisoTotal" class="block text-sm font-medium text-gray-700">Horas de Sobreaviso</label>
                            <input type="text" id="horasSobreavisoTotal" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                        <div>
                            <label for="horasTrabalhadas50" class="block text-sm font-medium text-gray-700">Horas de Sobreaviso Trabalhado</label>
                            <input type="text" id="horasTrabalhadas50" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                        <div>
                            <label for="horasTrabalhadas100" class="block text-sm font-medium text-gray-700">Horas Extras 50% (Normal)</label>
                            <input type="text" id="horasTrabalhadas100" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                         <div>
                            <label for="horasNoturnas" class="block text-sm font-medium text-gray-700">Horas de Adicional Noturno</label>
                            <input type="text" id="horasNoturnas" value="00:00" placeholder="HH:MM" class="mt-1 text-center">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 p-4 bg-gray-50 rounded-lg border">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Fator DSR, Dias e Ausências</h3>
                    <div class="grid grid-cols-4 gap-4">
                         <div>
                            <label for="mesReferencia" class="block text-sm font-medium text-gray-700">Mês Ref.</label>
                            <input type="month" id="mesReferencia" class="mt-1">
                        </div>
                        <div>
                            <label for="totalDiasNoMes" class="block text-sm font-medium text-gray-700">Total Dias Mês</label>
                            <input type="number" id="totalDiasNoMes" min="1" readonly class="mt-1 bg-gray-200 text-center">
                        </div>
                        <div>
                            <label for="diasTrabalhados" class="block text-sm font-medium text-gray-700">Dias Normais (Presença)</label>
                            <input type="number" id="diasTrabalhados" min="1" max="30" class="mt-1 text-center">
                            <p class="text-xs text-blue-600 font-medium">Determina quais domingos/feriados contam para DSR</p>
                        </div>
                         <div>
                            <label for="diasAtestado" class="block text-sm font-medium text-gray-700">Dias de Atestado</label>
                            <input type="number" id="diasAtestado" value="0" min="0" class="mt-1 text-center">
                            <p class="text-xs text-red-500">Afeta Periculosidade.</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 pt-4 border-t">
                        <div>
                            <label for="diasDomingo" class="block text-sm font-medium text-gray-700">Domingos (DSR Calc.)</label>
                            <input type="number" id="diasDomingo" value="4" min="0" readonly class="mt-1 bg-gray-200 text-center">
                            <p class="text-xs text-gray-500">Total de domingos no mês (referência)</p>
                        </div>
                        <div class="holidays-field-container">
                            <label for="diasFeriado" class="block text-sm font-medium text-gray-700">Feriados (DSR Manual)</label>
                            <input type="number" id="diasFeriado" value="0" min="0" class="mt-1 text-center w-full">
                            <p class="text-xs text-gray-500">Feriados após os dias trabalhados</p>
                        </div>
                        <div>
                            <label for="diasUteis" class="block text-sm font-medium text-gray-700">Dias Úteis (Líquidos)</label>
                            <input type="number" id="diasUteis" value="26" min="1" readonly data-base-value="26" class="mt-1 bg-indigo-100 font-bold text-center">
                            <p class="text-xs text-gray-500">Base para cálculo do fator DSR</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna de Resultados -->
            <div>
                <h2 class="text-xl font-semibold mb-4 titulo-cor">Resultados e Bases</h2>

                <!-- BLOCO ADICIONAIS -->
                <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-6">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Adicionais e Periculosidade</h3>
                    
                    <div class="flex justify-between text-base font-semibold">
                        <span>Periculosidade (30%)</span>
                        <span id="valorPericulosidade" class="titulo-cor">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-sm">
                        <span>Horas de Sobreaviso (Espera):</span>
                        <span id="valorSobreavisoEspera" class="titulo-cor">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-sm">
                        <span>Horas de Sobreaviso Trabalhado (50%):</span>
                        <span id="valorHoraExtraTrabalho50" class="titulo-cor">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Horas Extras 50% (Normal):</span>
                        <span id="valorHoraExtraTrabalho100" class="titulo-cor">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Horas de Adicional Noturno:</span>
                        <span id="valorAdicionalNoturno" class="titulo-cor">R$ 0,00</span>
                    </div>
                </div>

                <!-- BLOCO REFLEXOS DSR -->
                <div class="space-y-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <h3 class="font-bold text-lg border-b pb-2 titulo-cor">Reflexos DSR (Fator: <span id="fatorDSRDisplay" class="font-extrabold">0.0000</span>)</h3>
                    <p class="text-xs text-gray-600 italic mb-2">Cálculo considera apenas domingos/feriados após os dias trabalhados</p>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Sobreaviso DSR (Espera 1/3):</span>
                        <span id="valorReflexoSobreavisoEspera" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Sob. Trabalhado DSR (HE 50%):</span>
                        <span id="valorReflexoSobreavisoTrabalhado" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Horas Extras DSR (Normal 50%):</span>
                        <span id="valorReflexoHorasExtrasNormal" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>
                    
                    <div class="flex justify-between text-sm">
                        <span>Reflexo Adic. Noturno DSR:</span>
                        <span id="valorReflexoAdicionalNoturno" class="text-indigo-700 font-semibold">R$ 0,00</span>
                    </div>

                    <div class="flex justify-between text-lg font-bold pt-2 border-t border-indigo-300">
                        <span>TOTAL DOS REFLEXOS:</span>
                        <span id="valorReflexoDSRTotalSum" class="titulo-cor">R$ 0,00</span>
                    </div>
                </div>
                
                <!-- BLOCO BASES DE CÁLCULO (OPCIONAL) -->
                <div class="mt-6">
                    <button id="toggleBases" class="toggle-bases-btn w-full text-left p-3 bg-indigo-100 hover:bg-indigo-200 rounded-lg border border-indigo-300 transition duration-150 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg titulo-cor">Bases de Cálculo por Hora</h3>
                            <span class="text-indigo-600">
                                <i class="fas fa-chevron-down" id="basesIcon"></i>
                            </span>
                        </div>
                    </button>
                    
                    <div id="basesContainer" class="p-4 bg-indigo-50 rounded-lg border border-indigo-200 space-y-4 hidden">
                        <div class="flex justify-between text-sm">
                            <span>Hora Normal:</span>
                            <span id="horaNormal" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Hora Sob. (1/3):</span>
                            <span id="horaSobreaviso" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Base p/ HE (c/ Peric.):</span>
                            <span id="baseHePeric" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Hora Extra (50% c/ Peric.):</span>
                            <span id="horaExtra50" class="font-semibold titulo-cor">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTÕES DE AÇÃO NO FINAL DA PÁGINA -->
        <div class="flex flex-wrap justify-end gap-4 mt-12 print-hide border-t pt-6">
            <button id="saveCalculation" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-save mr-1"></i> Salvar Cálculo
                <span id="saveCloudBadge" class="sync-badge ml-2" style="display: none;">Cloud</span>
            </button>
            <button id="clearButton" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-eraser mr-1"></i> Limpar
            </button>
            <button id="printButton" class="text-sm font-semibold py-2 px-4 rounded-lg transition duration-150">
                <i class="fas fa-print mr-1"></i> Salvar em PDF
            </button>
        </div>
    </div>

    <!-- CONTEÚDO DE LISTA DE COLABORADORES (COM BOTÕES DE STATUS) -->
    <div class="container hidden" id="collaboratorsContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-users mr-2"></i> Gerenciar Colaboradores
            <span id="cloudCollaboratorBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg titulo-cor">Gerenciar Colaboradores</h3>
                    <p class="text-sm text-gray-600">Visualize, edite ou altere o status dos colaboradores cadastrados</p>
                </div>
                <div class="flex gap-2">
                    <button id="refreshCollaboratorList" class="text-blue-600 hover:text-blue-800 px-3 py-1">
                        <i class="fas fa-sync-alt mr-1"></i> Atualizar
                    </button>
                    <button id="addNewCollaborator" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-user-plus mr-1"></i> Novo Colaborador
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Botões para alternar entre Ativos e Inativos -->
        <div class="status-toggle-buttons print-hide">
            <button class="status-toggle-btn active" id="showActiveCollaborators">
                <i class="fas fa-user-check mr-1"></i> Ativos
            </button>
            <button class="status-toggle-btn" id="showInactiveCollaborators">
                <i class="fas fa-user-slash mr-1"></i> Inativos
            </button>
        </div>
        
        <!-- Container para tabela de colaboradores -->
        <div id="collaboratorsTableContainer">
            <!-- Conteúdo será preenchido dinamicamente -->
        </div>
    </div>

    <!-- CONTEÚDO DE GERENCIAMENTO DE DEPARTAMENTOS -->
    <div class="container hidden" id="departmentsContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-building mr-2"></i> Departamentos da Empresa
            <span id="cloudDepartmentBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg titulo-cor">Gerenciar Departamentos</h3>
                    <p class="text-sm text-gray-600">Adicione, edite ou exclua departamentos da empresa</p>
                </div>
                <div class="flex gap-2">
                    <button id="refreshDepartments" class="text-blue-600 hover:text-blue-800 px-3 py-1">
                        <i class="fas fa-sync-alt mr-1"></i> Atualizar
                    </button>
                    <button id="addNewDepartment" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-plus mr-1"></i> Novo Departamento
                    </button>
                </div>
            </div>
        </div>
        
        <div id="departmentsTableContainer">
            <!-- Tabela será preenchida via JavaScript -->
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-building fa-3x mb-4"></i>
                <p class="text-lg">Nenhum departamento cadastrado ainda.</p>
                <p class="text-sm">Clique em "Novo Departamento" para cadastrar seu primeiro departamento.</p>
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg border">
            <h3 class="font-bold text-lg titulo-cor mb-4">Estatísticas</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold titulo-cor" id="totalDepartments">0</div>
                    <div class="text-sm text-gray-600">Total de Departamentos</div>
                </div>
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold text-green-600" id="activeDepartments">0</div>
                    <div class="text-sm text-gray-600">Departamentos Ativos</div>
                </div>
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold text-blue-600" id="collaboratorsByDepartment">0</div>
                    <div class="text-sm text-gray-600">Colaboradores Vinculados</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO DE HISTÓRICO DE CÁLCULOS - APENAS TABELA -->
    <div class="container hidden" id="historyContent">
        <h1 class="text-3xl font-bold titulo-cor text-center mb-6 border-b pb-2">
            <i class="fas fa-history mr-2"></i> Histórico de Cálculos
            <span id="cloudHistoryBadge" class="sync-badge text-xs ml-2" style="display: none;">Sincronizado</span>
        </h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h3 class="font-bold text-lg titulo-cor">Histórico de Cálculos</h3>
                    <p class="text-sm text-gray-600">Visualize todos os cálculos salvos em formato de tabela</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <div class="relative flex-grow md:flex-grow-0">
                        <input type="text" id="searchCollaborator" placeholder="Buscar por nome ou departamento..." 
                               class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                    <button id="refreshHistory" class="text-blue-600 hover:text-blue-800 px-3 py-2">
                        <i class="fas fa-sync-alt mr-1"></i> Atualizar
                    </button>
                    <button id="clearHistoryFilters" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded">
                        <i class="fas fa-filter-circle-xmark mr-1"></i> Limpar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div id="historyFilters" class="mt-4 p-4 bg-white rounded border">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Colaborador</label>
                        <select id="filterCollaborator" class="w-full">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Departamento</label>
                        <select id="filterDepartment" class="w-full">
                            <option value="">Todos os departamentos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Período Início</label>
                        <input type="month" id="filterStartMonth" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Período Fim</label>
                        <input type="month" id="filterEndMonth" class="w-full">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Estatísticas do Histórico -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
            <h3 class="font-bold text-lg titulo-cor mb-4">Resumo</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold titulo-cor" id="totalCalculations">0</div>
                    <div class="text-sm text-gray-600">Total de Cálculos</div>
                </div>
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalCollaboratorsWithHistory">0</div>
                    <div class="text-sm text-gray-600">Colaboradores</div>
                </div>
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalMonths">0</div>
                    <div class="text-sm text-gray-600">Meses</div>
                </div>
                <div class="p-4 bg-white rounded border text-center">
                    <div class="text-2xl font-bold text-purple-600" id="totalReflexos">R$ 0,00</div>
                    <div class="text-sm text-gray-600">Total Reflexos</div>
                </div>
            </div>
        </div>
        
        <!-- Tabela de Histórico (SIMPLIFICADA) -->
        <div class="overflow-x-auto">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Mês Referência</th>
                        <th>Colaborador</th>
                        <th>Departamento</th>
                        <th>Data Cálculo</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-history fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum cálculo salvo ainda.</p>
                            <p class="text-sm">Faça cálculos na aba "Calculadora" e salve-os para ver o histórico aqui.</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Botões de exportação do histórico -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg border">
            <h3 class="font-bold text-lg titulo-cor mb-4">Exportar Relatórios</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="exportHistoryCSV" class="bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-3 px-4 rounded-lg transition duration-150">
                    <i class="fas fa-file-csv mr-2"></i> Exportar CSV
                </button>
                <button id="exportHistoryPDF" class="bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-3 px-4 rounded-lg transition duration-150">
                    <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
                </button>
                <button id="exportHistoryExcel" class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-3 px-4 rounded-lg transition duration-150">
                    <i class="fas fa-file-excel mr-2"></i> Exportar Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE (COM SUAS CREDENCIAIS)
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDUyddWZtEOMYsP2ZoaeJLU2OdgV9E1l94",
            authDomain: "calculadora-folha-pagamento.firebaseapp.com",
            projectId: "calculadora-folha-pagamento",
            storageBucket: "calculadora-folha-pagamento.firebasestorage.app",
            messagingSenderId: "286786547060",
            appId: "1:286786547060:web:74c68fef3dd79fc61a9021",
            measurementId: "G-BHGRTCWWYK"
        };

        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("✅ Firebase inicializado com sucesso!");
        } catch (error) {
            console.error("❌ Erro ao inicializar Firebase:", error);
        }

        // Inicializar serviços
        const db = firebase.firestore();
        const auth = firebase.auth();
        const analytics = firebase.analytics();

        // Variáveis globais
        let currentUser = null;
        let isOnline = false;
        let userData = null;

        // ============================================
        // FUNÇÕES DE AUTENTICAÇÃO FIREBASE
        // ============================================
        
        // Monitorar estado de autenticação
        auth.onAuthStateChanged((user) => {
            updateAuthUI(user);
            
            if (user) {
                currentUser = user;
                isOnline = true;
                loadUserData();
            } else {
                currentUser = null;
                isOnline = false;
                userData = null;
            }
        });

        // Atualizar interface de autenticação
        function updateAuthUI(user) {
            const statusElement = document.getElementById('firebaseStatus');
            const loginModal = document.getElementById('loginModal');
            const userInfo = document.getElementById('userInfo');
            const userEmail = document.getElementById('userEmail');
            const logoutBtn = document.getElementById('btnLogout');
            
            if (user) {
                // Usuário logado
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = '<i class="fas fa-cloud"></i> <span>Sincronizado com a nuvem</span>';
                
                userInfo.style.display = 'flex';
                userEmail.textContent = user.email;
                logoutBtn.style.display = 'block';
                
                // Mostrar badges de sincronização
                document.querySelectorAll('.sync-badge').forEach(badge => {
                    badge.style.display = 'inline-block';
                });
                
                // Esconder modal de login se estiver visível
                if (loginModal.style.display === 'flex') {
                    loginModal.style.display = 'none';
                }
                
            } else {
                // Usuário não logado
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-laptop"></i> <span>Modo offline (apenas local)</span>';
                
                userInfo.style.display = 'none';
                logoutBtn.style.display = 'none';
                
                // Esconder badges de sincronização
                document.querySelectorAll('.sync-badge').forEach(badge => {
                    badge.style.display = 'none';
                });
                
                // Mostrar modal de login se nunca escolheu continuar offline
                if (!localStorage.getItem('skipLogin') && loginModal.style.display !== 'flex') {
                    loginModal.style.display = 'flex';
                }
            }
        }

        // Carregar dados do usuário do Firestore
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log("✅ Dados do usuário carregados do Firestore");
                    
                    // Sincronizar dados locais com Firebase
                    await syncDataWithFirebase();
                    
                } else {
                    // Criar dados iniciais para novo usuário
                    await initializeUserData();
                }
            } catch (error) {
                console.error("❌ Erro ao carregar dados do usuário:", error);
                updateFirebaseStatus('error', 'Erro ao carregar dados da nuvem');
            }
        }

        // Inicializar dados do usuário
        async function initializeUserData() {
            if (!currentUser) return;
            
            try {
                const initialData = {
                    email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    departments: DEFAULT_DEPARTMENTS,
                    collaborators: [],
                    calculations: [],
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).set(initialData);
                userData = initialData;
                console.log("✅ Dados iniciais criados no Firestore");
                
            } catch (error) {
                console.error("❌ Erro ao inicializar dados do usuário:", error);
            }
        }

        // Sincronizar dados locais com Firebase
        async function syncDataWithFirebase() {
            if (!currentUser || !userData) return;
            
            try {
                // Sincronizar departamentos
                const localDepartments = getDepartmentsFromStorage();
                if (localDepartments.length > 0 && 
                    (!userData.departments || userData.departments.length === 0)) {
                    // Se Firebase está vazio mas local tem dados, enviar para Firebase
                    await updateFirebaseData('departments', localDepartments);
                } else if (userData.departments && userData.departments.length > 0) {
                    // Se Firebase tem dados, usar eles
                    saveDepartmentsToStorage(userData.departments);
                }
                
                // Sincronizar colaboradores
                const localCollaborators = getCollaboratorsFromStorage();
                if (localCollaborators.length > 0 && 
                    (!userData.collaborators || userData.collaborators.length === 0)) {
                    await updateFirebaseData('collaborators', localCollaborators);
                } else if (userData.collaborators && userData.collaborators.length > 0) {
                    saveCollaboratorsToStorage(userData.collaborators);
                }
                
                // Sincronizar cálculos
                const localCalculations = getCalculationsFromStorage();
                if (localCalculations.length > 0 && 
                    (!userData.calculations || userData.calculations.length === 0)) {
                    await updateFirebaseData('calculations', localCalculations);
                } else if (userData.calculations && userData.calculations.length > 0) {
                    saveCalculationsToStorage(userData.calculations);
                }
                
                console.log("✅ Sincronização concluída");
                updateFirebaseStatus('success', 'Dados sincronizados');
                
            } catch (error) {
                console.error("❌ Erro na sincronização:", error);
                updateFirebaseStatus('error', 'Erro na sincronização');
            }
        }

        // Atualizar dados no Firebase
        async function updateFirebaseData(field, data) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    [field]: data,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Atualizar dados locais também
                userData[field] = data;
                console.log(`✅ ${field} atualizados no Firebase`);
                
            } catch (error) {
                console.error(`❌ Erro ao atualizar ${field}:`, error);
                throw error;
            }
        }

        // Atualizar status do Firebase na interface
        function updateFirebaseStatus(type, message) {
            const statusElement = document.getElementById('firebaseStatus');
            
            switch(type) {
                case 'success':
                    statusElement.className = 'firebase-status firebase-connected';
                    statusElement.innerHTML = `<i class="fas fa-check"></i> <span>${message}</span>`;
                    break;
                case 'error':
                    statusElement.className = 'firebase-status firebase-disconnected';
                    statusElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${message}</span>`;
                    break;
                case 'loading':
                    statusElement.className = 'firebase-status firebase-loading';
                    statusElement.innerHTML = `<i class="fas fa-sync fa-spin"></i> <span>${message}</span>`;
                    break;
            }
        }

        // ============================================
        // FUNÇÕES DE LOGIN/CADASTRO
        // ============================================
        
        // Alternar entre login e cadastro
        document.getElementById('tabLogin').addEventListener('click', () => {
            document.getElementById('tabLogin').classList.add('active');
            document.getElementById('tabSignup').classList.remove('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginError').classList.add('hidden');
        });
        
        document.getElementById('tabSignup').addEventListener('click', () => {
            document.getElementById('tabSignup').classList.add('active');
            document.getElementById('tabLogin').classList.remove('active');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginError').classList.add('hidden');
        });

        // Login
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            if (!email || !password) {
                errorText.textContent = 'Por favor, preencha email e senha.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            updateFirebaseStatus('loading', 'Fazendo login...');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorElement.classList.add('hidden');
                updateFirebaseStatus('success', 'Login realizado!');
                
            } catch (error) {
                console.error('❌ Erro no login:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.remove('hidden');
                updateFirebaseStatus('error', 'Erro no login');
            }
        });

        // Cadastro
        document.getElementById('btnSignup').addEventListener('click', async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const errorElement = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            if (!email || !password || !confirmPassword) {
                errorText.textContent = 'Por favor, preencha todos os campos.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password !== confirmPassword) {
                errorText.textContent = 'As senhas não coincidem.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (password.length < 6) {
                errorText.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            updateFirebaseStatus('loading', 'Criando conta...');
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                errorElement.classList.add('hidden');
                updateFirebaseStatus('success', 'Conta criada com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro no cadastro:', error);
                errorText.textContent = getFirebaseErrorMessage(error.code);
                errorElement.classList.remove('hidden');
                updateFirebaseStatus('error', 'Erro no cadastro');
            }
        });

        // Continuar offline
        document.getElementById('btnContinueOffline').addEventListener('click', () => {
            localStorage.setItem('skipLogin', 'true');
            document.getElementById('loginModal').style.display = 'none';
            updateFirebaseStatus('disconnected', 'Modo offline ativado');
        });

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut();
            localStorage.removeItem('skipLogin');
            updateFirebaseStatus('disconnected', 'Desconectado');
        });

        // Traduzir mensagens de erro do Firebase
        function getFirebaseErrorMessage(errorCode) {
            const messages = {
                'auth/user-not-found': 'Usuário não encontrado.',
                'auth/wrong-password': 'Senha incorreta.',
                'auth/email-already-in-use': 'Este email já está em uso.',
                'auth/weak-password': 'A senha é muito fraca.',
                'auth/invalid-email': 'Email inválido.',
                'auth/network-request-failed': 'Erro de conexão. Verifique sua internet.',
                'auth/too-many-requests': 'Muitas tentativas. Tente novamente mais tarde.',
                'auth/user-disabled': 'Esta conta foi desativada.'
            };
            
            return messages[errorCode] || 'Ocorreu um erro. Tente novamente.';
        }

        // ============================================
        // FUNÇÕES DE ARMAZENAMENTO (AGORA COM FIREBASE)
        // ============================================
        
        const COLLABORATORS_STORAGE_KEY = 'folha_colaboradores_cadastrados';
        const CALCULATIONS_STORAGE_KEY = 'folha_calculos_salvos';
        const DEPARTMENTS_STORAGE_KEY = 'folha_departamentos';
        
        // Departamentos padrão
        const DEFAULT_DEPARTMENTS = [
            { id: 1, name: "Produção", active: true },
            { id: 2, name: "Manutenção", active: true },
            { id: 3, name: "Administrativo", active: true },
            { id: 4, name: "RH", active: true },
            { id: 5, name: "Financeiro", active: true },
            { id: 6, name: "TI", active: true },
            { id: 7, name: "Comercial", active: true },
            { id: 8, name: "Logística", active: true },
            { id: 9, name: "Qualidade", active: true },
            { id: 10, name: "Segurança", active: true }
        ];
        
        // Funções de obtenção de dados do localStorage
        function getDepartmentsFromStorage() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCollaboratorsFromStorage() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getCalculationsFromStorage() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        // Funções de salvamento (agora sincronizam com Firebase)
        async function saveDepartments(departments) {
            // Salvar localmente
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
            
            // Se estiver logado, salvar no Firebase também
            if (currentUser) {
                try {
                    await updateFirebaseData('departments', departments);
                    updateFirebaseStatus('success', 'Departamentos sincronizados');
                } catch (error) {
                    console.error("❌ Erro ao sincronizar departamentos:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            // Atualizar userData local
            if (userData) {
                userData.departments = departments;
            }
        }
        
        async function saveCollaborators(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
            
            if (currentUser) {
                try {
                    await updateFirebaseData('collaborators', collaborators);
                    updateFirebaseStatus('success', 'Colaboradores sincronizados');
                } catch (error) {
                    console.error("❌ Erro ao sincronizar colaboradores:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            if (userData) {
                userData.collaborators = collaborators;
            }
        }
        
        async function saveCalculations(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
            
            if (currentUser) {
                try {
                    await updateFirebaseData('calculations', calculations);
                    updateFirebaseStatus('success', 'Cálculos sincronizados');
                } catch (error) {
                    console.error("❌ Erro ao sincronizar cálculos:", error);
                    updateFirebaseStatus('error', 'Erro na sincronização');
                }
            }
            
            if (userData) {
                userData.calculations = calculations;
            }
        }
        
        // Funções de obtenção (compatibilidade com código existente)
        function getDepartments() {
            const savedData = localStorage.getItem(DEPARTMENTS_STORAGE_KEY);
            if (!savedData) {
                saveDepartments(DEFAULT_DEPARTMENTS);
                return DEFAULT_DEPARTMENTS;
            }
            return JSON.parse(savedData);
        }
        
        function getCollaborators() {
            const savedData = localStorage.getItem(COLLABORATORS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function getSavedCalculations() {
            const savedData = localStorage.getItem(CALCULATIONS_STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }
        
        function saveDepartmentsToStorage(departments) {
            localStorage.setItem(DEPARTMENTS_STORAGE_KEY, JSON.stringify(departments));
        }
        
        function saveCollaboratorsToStorage(collaborators) {
            localStorage.setItem(COLLABORATORS_STORAGE_KEY, JSON.stringify(collaborators));
        }
        
        function saveCalculationsToStorage(calculations) {
            localStorage.setItem(CALCULATIONS_STORAGE_KEY, JSON.stringify(calculations));
        }

        // ============================================
        // FUNÇÕES GERAIS E DE CÁLCULO (MANTIDAS)
        // ============================================
        
        // Função utilitária para formatação de moeda
        const R$ = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        // Função para obter o mês atual no formato YYYY-MM
        function getCurrentMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        
        // Função utilitária para converter HH:MM para horas decimais
        function parseTime(timeString) {
            if (!timeString) return 0;
            const parts = timeString.split(':');
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);

            if (isNaN(hours) || isNaN(minutes) || minutes >= 60 || hours < 0 || minutes < 0) {
                console.error("Formato de hora inválido: " + timeString);
                return 0;
            }

            return hours + (minutes / 60);
        }
        
        /**
         * Aplica a máscara de moeda brasileira (ponto milhar, vírgula decimal)
         */
        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length === 0) {
                input.value = '';
                return;
            }

            while (value.length < 3) {
                value = '0' + value;
            }

            let integerPart = value.slice(0, -2);
            let decimalPart = value.slice(-2);

            integerPart = parseInt(integerPart, 10).toString();
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            input.value = integerPart + ',' + decimalPart;
        }

        /**
         * Calcula o número de domingos (DSR), dias úteis e total de dias em um determinado mês/ano.
         */
        function getDSRDays(year, monthIndex) {
            const date = new Date(year, monthIndex, 1);
            let totalDays = 0;
            let sundays = 0;
            
            while (date.getMonth() === monthIndex) {
                totalDays++;
                if (date.getDay() === 0) {
                    sundays++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            const diasUteis = totalDays - sundays;

            return {
                diasDSR: sundays,
                diasUteis: diasUteis,
                totalDaysInMonth: totalDays 
            };
        }
        
        /**
         * Função auxiliar para calcular quantos domingos ocorrem após uma data específica
         */
        function getSundaysAfterDate(year, monthIndex, diasTrabalhados) {
            if (!diasTrabalhados || diasTrabalhados <= 0) return 0;
            
            const date = new Date(year, monthIndex, diasTrabalhados + 1);
            let sundaysAfter = 0;
            
            while (date.getMonth() === monthIndex) {
                if (date.getDay() === 0) {
                    sundaysAfter++;
                }
                date.setDate(date.getDate() + 1);
            }
            
            return sundaysAfter;
        }
        
        // Função que lida com a mudança do mês de referência
        function handleMonthChange(isInitialLoad = false) {
            const monthInput = document.getElementById('mesReferencia').value;
            if (!monthInput) return;

            const [year, month] = monthInput.split('-').map(Number);
            
            const result = getDSRDays(year, month - 1);
            
            document.getElementById('diasDomingo').value = result.diasDSR;
            document.getElementById('totalDiasNoMes').value = result.totalDaysInMonth;
            
            const diasTrabalhadosInput = document.getElementById('diasTrabalhados');
            
            if (isInitialLoad || diasTrabalhadosInput.value === "") {
                diasTrabalhadosInput.value = Math.min(result.totalDaysInMonth, 30);
                if (isInitialLoad) {
                    document.getElementById('diasAtestado').value = 0;
                } 
            }
            
            const currentWorkedDays = parseFloat(diasTrabalhadosInput.value);
            if (!currentWorkedDays || currentWorkedDays > result.totalDaysInMonth) {
                 diasTrabalhadosInput.value = Math.min(result.totalDaysInMonth, 30);
            }
            
            const diasUteisInput = document.getElementById('diasUteis');
            diasUteisInput.setAttribute('data-base-value', result.diasUteis);

            loadHolidaysForYear(year);
            
            calcular();
        }

        // Função principal de cálculo
        function calcular() {
            const salarioBaseInput = document.getElementById('salarioBase').value;
            const salarioBaseFormatted = salarioBaseInput.replace(/\./g, '').replace(',', '.'); 
            const salarioBase = parseFloat(salarioBaseFormatted) || 0;

            const divisorMensal = parseFloat(document.getElementById('divisorMensal').value) || 220; 
            const usaPericulosidade = document.getElementById('usaPericulosidade').checked;
            
            const horasSobreavisoTotal = parseTime(document.getElementById('horasSobreavisoTotal').value);
            const horasTrabalhadas50 = parseTime(document.getElementById('horasTrabalhadas50').value); 
            const horasTrabalhadas100 = parseTime(document.getElementById('horasTrabalhadas100').value); 
            const horasNoturnas = parseTime(document.getElementById('horasNoturnas').value);

            const diasAtestado = parseFloat(document.getElementById('diasAtestado').value) || 0; 
            const diasTrabalhados = parseFloat(document.getElementById('diasTrabalhados').value) || 0;
            const diasFeriado = parseFloat(document.getElementById('diasFeriado').value) || 0;
            const diasUteisInput = document.getElementById('diasUteis');
            const diasUteisBase = parseFloat(diasUteisInput.getAttribute('data-base-value')) || 0;

            const monthInput = document.getElementById('mesReferencia').value;
            let diasDomingoAfterWork = 0;
            
            if (monthInput) {
                const [year, month] = monthInput.split('-').map(Number);
                diasDomingoAfterWork = getSundaysAfterDate(year, month - 1, diasTrabalhados);
            }

            if (divisorMensal <= 0 || diasUteisBase <= 0 || salarioBase <= 0) {
                 document.getElementById('horaNormal').textContent = R$.format(0);
                 document.getElementById('valorPericulosidade').textContent = R$.format(0);
                 document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(0);
                 document.getElementById('valorSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(0);
                 document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(0);
                 document.getElementById('valorAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('fatorDSRDisplay').textContent = "0.0000";
                 document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(0);
                 document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(0);
                 document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(0);
                 document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(0);
                 document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(0);
                 document.getElementById('horaSobreaviso').textContent = R$.format(0);
                 document.getElementById('baseHePeric').textContent = R$.format(0) + " (s/ Salário)";
                 document.getElementById('horaExtra50').textContent = R$.format(0);
                 return;
            }
            
            const divisorFixoPericulosidade = 30;
            const diasBasePericulosidadeLiquida = Math.max(0, diasTrabalhados - diasAtestado);
            const fatorProRata = divisorFixoPericulosidade > 0 ? diasBasePericulosidadeLiquida / divisorFixoPericulosidade : 0;

            const horaNormal = salarioBase / divisorMensal;
            
            const periculosidadeValorMensal = salarioBase * 0.30;
            const periculosidadeValorProRata = usaPericulosidade ? periculosidadeValorMensal * fatorProRata : 0; 

            const periculosidadeHora = periculosidadeValorMensal / divisorMensal; 
            
            let baseHE = horaNormal;
            if (usaPericulosidade) {
                baseHE += periculosidadeHora;
            }
            
            const horasEspera = horasSobreavisoTotal; 
            const horaSobreaviso = horaNormal / 3;
            const valorSobreavisoEspera = horasEspera * horaSobreaviso; 

            const baseHePericRate = baseHE;
            const horaExtra50Valor = baseHE * 1.5;
            
            const valorHoraExtraTrabalho50 = horasTrabalhadas50 * horaExtra50Valor; 
            const valorHoraExtraTrabalho100 = horasTrabalhadas100 * horaExtra50Valor; 
            
            const adicionalNoturnoHora = horaNormal * 0.20;
            const valorAdicionalNoturno = horasNoturnas * adicionalNoturnoHora;

            const diasDSRParaCalculo = diasDomingoAfterWork + diasFeriado;
            const fatorDSR = diasTrabalhados > 0 ? diasDSRParaCalculo / diasTrabalhados : 0;
            
            document.getElementById('diasUteis').value = diasTrabalhados.toFixed(0); 

            const valorReflexoSobreavisoEspera = valorSobreavisoEspera * fatorDSR;
            const valorReflexoSobreavisoTrabalhado = valorHoraExtraTrabalho50 * fatorDSR;
            const valorReflexoHorasExtrasNormal = valorHoraExtraTrabalho100 * fatorDSR;
            const valorReflexoAdicionalNoturno = valorAdicionalNoturno * fatorDSR;

            const valorReflexoDSRTotal = valorReflexoSobreavisoEspera + valorReflexoSobreavisoTrabalhado + valorReflexoHorasExtrasNormal + valorReflexoAdicionalNoturno;

            document.getElementById('valorPericulosidade').textContent = R$.format(periculosidadeValorProRata);
            document.getElementById('valorPericulosidadeInputDisplay').textContent = R$.format(periculosidadeValorProRata);

            document.getElementById('valorSobreavisoEspera').textContent = R$.format(valorSobreavisoEspera);
            document.getElementById('valorHoraExtraTrabalho50').textContent = R$.format(valorHoraExtraTrabalho50);
            document.getElementById('valorHoraExtraTrabalho100').textContent = R$.format(valorHoraExtraTrabalho100); 
            document.getElementById('valorAdicionalNoturno').textContent = R$.format(valorAdicionalNoturno);
            

            document.getElementById('fatorDSRDisplay').textContent = fatorDSR.toFixed(4);
            document.getElementById('valorReflexoSobreavisoEspera').textContent = R$.format(valorReflexoSobreavisoEspera);
            document.getElementById('valorReflexoSobreavisoTrabalhado').textContent = R$.format(valorReflexoSobreavisoTrabalhado);
            document.getElementById('valorReflexoHorasExtrasNormal').textContent = R$.format(valorReflexoHorasExtrasNormal);
            document.getElementById('valorReflexoAdicionalNoturno').textContent = R$.format(valorReflexoAdicionalNoturno);
            document.getElementById('valorReflexoDSRTotalSum').textContent = R$.format(valorReflexoDSRTotal);
            
            document.getElementById('horaNormal').textContent = R$.format(horaNormal);
            document.getElementById('horaSobreaviso').textContent = R$.format(horaSobreaviso);
            document.getElementById('baseHePeric').textContent = usaPericulosidade 
                ? R$.format(baseHePericRate) + " (c/ Peric.)" 
                : R$.format(baseHePericRate) + " (s/ Peric.)";
            document.getElementById('horaExtra50').textContent = R$.format(horaExtra50Valor);
        }

        /**
         * Reseta todos os campos de entrada para seus valores padrão/vazios.
         */
        function resetInputs() {
            document.getElementById('salarioBase').value = "";
            document.getElementById('diasFeriado').value = "0";
            document.getElementById('diasAtestado').value = "0";

            document.getElementById('horasSobreavisoTotal').value = "00:00";
            document.getElementById('horasTrabalhadas50').value = "00:00";
            document.getElementById('horasTrabalhadas100').value = "00:00";
            document.getElementById('horasNoturnas').value = "00:00";

            document.getElementById('divisorMensal').value = "220";
            document.getElementById('usaPericulosidade').checked = true;
            
            handleMonthChange(true);
        }

        // ============================================
        // FUNÇÕES PARA CARREGAR FERIADOS NACIONAIS
        // ============================================
        
        let holidaysCache = {};
        
        async function loadHolidaysForYear(year) {
            if (holidaysCache[year]) {
                updateHolidaysDisplay(year);
                return;
            }
            
            try {
                const holidays = await getBrazilianHolidays(year);
                holidaysCache[year] = holidays;
                updateHolidaysDisplay(year);
            } catch (error) {
                console.error("Erro ao carregar feriados:", error);
                loadFixedHolidays(year);
            }
        }
        
        async function getBrazilianHolidays(year) {
            try {
                const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${year}`);
                
                if (response.ok) {
                    const holidays = await response.json();
                    const enhancedHolidays = enhanceHolidaysList(holidays, year);
                    return enhancedHolidays;
                }
            } catch (error) {
                console.warn("BrasilAPI falhou, usando feriados fixos");
            }
            
            return loadFixedHolidays(year);
        }
        
        function enhanceHolidaysList(holidays, year) {
            const enhancedList = [...holidays];
            
            const hasJan1 = holidays.some(h => {
                const date = new Date(h.date);
                return date.getMonth() === 0 && date.getDate() === 1;
            });
            
            if (!hasJan1) {
                enhancedList.push({
                    date: `${year}-01-01`,
                    name: "Confraternização Universal",
                    type: "national"
                });
            }
            
            const importantHolidays = [
                { date: `${year}-04-21`, name: "Tiradentes", type: "national" },
                { date: `${year}-05-01`, name: "Dia do Trabalho", type: "national" },
                { date: `${year}-09-07`, name: "Independência do Brasil", type: "national" },
                { date: `${year}-10-12`, name: "Nossa Senhora Aparecida", type: "national" },
                { date: `${year}-11-02`, name: "Finados", type: "national" },
                { date: `${year}-11-15`, name: "Proclamação da República", type: "national" },
                { date: `${year}-12-25`, name: "Natal", type: "national" }
            ];
            
            importantHolidays.forEach(holiday => {
                const exists = enhancedList.some(h => h.date === holiday.date);
                if (!exists) {
                    enhancedList.push(holiday);
                }
            });
            
            const easterDate = calculateEaster(year);
            const carnivalDate = new Date(easterDate);
            carnivalDate.setDate(easterDate.getDate() - 47);
            
            const corpusChristiDate = new Date(easterDate);
            corpusChristiDate.setDate(easterDate.getDate() + 60);
            
            const goodFridayDate = new Date(easterDate);
            goodFridayDate.setDate(easterDate.getDate() - 2);
            
            const carnivalExists = enhancedList.some(h => {
                const date = new Date(h.date);
                return date.getMonth() === carnivalDate.getMonth() && 
                       date.getDate() === carnivalDate.getDate();
            });
            
            if (!carnivalExists) {
                enhancedList.push({
                    date: formatDate(carnivalDate),
                    name: "Carnaval",
                    type: "national"
                });
            }
            
            const goodFridayExists = enhancedList.some(h => {
                const date = new Date(h.date);
                return date.getMonth() === goodFridayDate.getMonth() && 
                       date.getDate() === goodFridayDate.getDate();
            });
            
            if (!goodFridayExists) {
                enhancedList.push({
                    date: formatDate(goodFridayDate),
                    name: "Sexta-feira Santa",
                    type: "national"
                });
            }
            
            const corpusChristiExists = enhancedList.some(h => {
                const date = new Date(h.date);
                return date.getMonth() === corpusChristiDate.getMonth() && 
                       date.getDate() === corpusChristiDate.getDate();
            });
            
            if (!corpusChristiExists) {
                enhancedList.push({
                    date: formatDate(corpusChristiDate),
                    name: "Corpus Christi",
                    type: "national"
                });
            }
            
            return enhancedList;
        }
        
        function loadFixedHolidays(year) {
            const fixedHolidays = [
                { date: `${year}-01-01`, name: "Confraternização Universal", type: "national" },
                { date: `${year}-04-21`, name: "Tiradentes", type: "national" },
                { date: `${year}-05-01`, name: "Dia do Trabalho", type: "national" },
                { date: `${year}-09-07`, name: "Independência do Brasil", type: "national" },
                { date: `${year}-10-12`, name: "Nossa Senhora Aparecida", type: "national" },
                { date: `${year}-11-02`, name: "Finados", type: "national" },
                { date: `${year}-11-15`, name: "Proclamação da República", type: "national" },
                { date: `${year}-12-25`, name: "Natal", type: "national" }
            ];
            
            const easterDate = calculateEaster(year);
            const carnivalDate = new Date(easterDate);
            carnivalDate.setDate(easterDate.getDate() - 47);
            
            const corpusChristiDate = new Date(easterDate);
            corpusChristiDate.setDate(easterDate.getDate() + 60);
            
            const goodFridayDate = new Date(easterDate);
            goodFridayDate.setDate(easterDate.getDate() - 2);
            
            fixedHolidays.push(
                { date: formatDate(carnivalDate), name: "Carnaval", type: "national" },
                { date: formatDate(goodFridayDate), name: "Sexta-feira Santa", type: "national" },
                { date: formatDate(corpusChristiDate), name: "Corpus Christi", type: "national" }
            );
            
            return fixedHolidays;
        }
        
        function calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            
            return new Date(year, month - 1, day);
        }
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function updateHolidaysDisplay(year) {
            const monthInput = document.getElementById('mesReferencia').value;
            if (!monthInput) return;
            
            const [selectedYear, selectedMonth] = monthInput.split('-').map(Number);
            
            if (selectedYear !== year) return;
            
            const holidays = holidaysCache[year] || [];
            const monthHolidays = holidays.filter(holiday => {
                const holidayDate = new Date(holiday.date);
                return holidayDate.getMonth() + 1 === selectedMonth;
            });
            
            const diasTrabalhados = parseFloat(document.getElementById('diasTrabalhados').value) || 0;
            let feriadosAfterWork = 0;
            
            if (diasTrabalhados > 0) {
                monthHolidays.forEach(holiday => {
                    const holidayDate = new Date(holiday.date);
                    const dayOfMonth = holidayDate.getDate();
                    if (dayOfMonth > diasTrabalhados) {
                        feriadosAfterWork++;
                    }
                });
            } else {
                feriadosAfterWork = 0;
            }
            
            document.getElementById('diasFeriado').value = feriadosAfterWork;
            calcular();
        }

        // ============================================
        // SISTEMA DE DEPARTAMENTOS
        // ============================================
        
        function updateDepartmentSelect() {
            const departments = getDepartments();
            const select = document.getElementById('collaboratorDepartment');
            const filterDepartment = document.getElementById('filterDepartment');
            
            select.innerHTML = '<option value="">Selecione...</option>';
            if (filterDepartment) {
                filterDepartment.innerHTML = '<option value="">Todos os departamentos</option>';
            }
            
            departments
                .filter(dept => dept.active)
                .forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.name;
                    option.textContent = department.name;
                    select.appendChild(option);
                    
                    if (filterDepartment) {
                        const filterOption = document.createElement('option');
                        filterOption.value = department.name;
                        filterOption.textContent = department.name;
                        filterDepartment.appendChild(filterOption);
                    }
                });
        }
        
        function updateCollaboratorFilterSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('filterCollaborator');
            
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os colaboradores</option>';
            
            collaborators
                .filter(collaborator => collaborator.active === true)
                .forEach(collaborator => {
                    const option = document.createElement('option');
                    option.value = collaborator.id;
                    option.textContent = `${collaborator.name} - ${collaborator.department}`;
                    select.appendChild(option);
                });
        }
        
        function renderDepartmentsTable() {
            const departments = getDepartments();
            const container = document.getElementById('departmentsTableContainer');
            
            if (departments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-building fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum departamento cadastrado ainda.</p>
                        <p class="text-sm">Clique em "Novo Departamento" para cadastrar seu primeiro departamento.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="department-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            departments.forEach(department => {
                html += `
                    <tr data-id="${department.id}">
                        <td class="font-medium">${department.name}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${department.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${department.active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="edit-department text-green-600 hover:text-green-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="delete-department text-red-600 hover:text-red-800 text-sm" data-id="${department.id}">
                                    <i class="fas fa-trash mr-1"></i> Excluir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${departments.length} departamento(s) cadastrado(s)
                </div>
            `;
            
            container.innerHTML = html;
            
            updateDepartmentStats();
            
            document.querySelectorAll('.edit-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editDepartment(id);
                });
            });
            
            document.querySelectorAll('.delete-department').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteDepartment(id);
                });
            });
        }
        
        function updateDepartmentStats() {
            const departments = getDepartments();
            const collaborators = getCollaborators();
            
            const totalDepartments = departments.length;
            const activeDepartments = departments.filter(dept => dept.active).length;
            
            const collaboratorsByDepartment = {};
            collaborators
                .filter(collaborator => collaborator.active === true)
                .forEach(collaborator => {
                    if (collaborator.department) {
                        collaboratorsByDepartment[collaborator.department] = (collaboratorsByDepartment[collaborator.department] || 0) + 1;
                    }
                });
            
            const totalCollaboratorsLinked = Object.values(collaboratorsByDepartment).reduce((sum, count) => sum + count, 0);
            
            document.getElementById('totalDepartments').textContent = totalDepartments;
            document.getElementById('activeDepartments').textContent = activeDepartments;
            document.getElementById('collaboratorsByDepartment').textContent = totalCollaboratorsLinked;
        }
        
        // ============================================
        // SISTEMA DE CADASTRO DE COLABORADORES
        // ============================================
        
        let currentCollaboratorStatus = 'active';
        
        async function saveCollaborator(event) {
            event.preventDefault();
            
            const id = document.getElementById('collaboratorEditId').value;
            const name = document.getElementById('collaboratorName').value.trim();
            const department = document.getElementById('collaboratorDepartment').value;
            const baseSalary = document.getElementById('collaboratorBaseSalary').value;
            const divisor = document.getElementById('collaboratorDivisor').value;
            const workHours = document.getElementById('collaboratorWorkHours').value;
            const periculosidade = document.getElementById('collaboratorPericulosidade').checked;
            const insalubridade = document.getElementById('collaboratorInsalubridade').checked;
            
            if (!name || !department || !baseSalary) {
                alert('Por favor, preencha os campos obrigatórios (Nome, Departamento e Salário Base).');
                return;
            }
            
            const baseSalaryFormatted = baseSalary.replace(/\./g, '').replace(',', '.');
            const baseSalaryValue = parseFloat(baseSalaryFormatted) || 0;
            
            if (baseSalaryValue <= 0) {
                alert('O salário base deve ser maior que zero.');
                return;
            }
            
            const collaborators = getCollaborators();
            let newCollaborator;
            
            if (id) {
                const existingIndex = collaborators.findIndex(c => c.id == id);
                
                if (existingIndex === -1) {
                    alert('Colaborador não encontrado!');
                    return;
                }
                
                newCollaborator = {
                    ...collaborators[existingIndex],
                    name: name,
                    department: department,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    updatedAt: new Date().toISOString()
                };
                
                collaborators[existingIndex] = newCollaborator;
            } else {
                const matricula = `COL${Date.now().toString().slice(-6)}`;
                
                newCollaborator = {
                    id: Date.now(),
                    name: name,
                    department: department,
                    matricula: matricula,
                    baseSalary: baseSalary,
                    baseSalaryValue: baseSalaryValue,
                    divisor: divisor,
                    workHours: workHours,
                    periculosidade: periculosidade,
                    insalubridade: insalubridade,
                    active: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                collaborators.push(newCollaborator);
            }
            
            await saveCollaborators(collaborators);
            
            closeModal();
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert(`Colaborador ${name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            resetCollaboratorForm();
        }
        
        function resetCollaboratorForm() {
            document.getElementById('collaboratorEditId').value = '';
            document.getElementById('collaboratorName').value = '';
            document.getElementById('collaboratorDepartment').value = '';
            document.getElementById('collaboratorBaseSalary').value = '';
            document.getElementById('collaboratorDivisor').value = '220';
            document.getElementById('collaboratorWorkHours').value = '8';
            document.getElementById('collaboratorPericulosidade').checked = false;
            document.getElementById('collaboratorInsalubridade').checked = false;
            
            document.getElementById('collaboratorModalTitle').textContent = "Cadastrar Novo Colaborador";
            document.getElementById('collaboratorModalButton').textContent = "Salvar Colaborador";
        }
        
        function updateCollaboratorSelect() {
            const collaborators = getCollaborators();
            const select = document.getElementById('collaboratorSelect');
            
            const currentSelection = select.value;
            select.innerHTML = '<option value="">-- Selecione um colaborador --</option>';
            
            collaborators
                .filter(collaborator => collaborator.active === true)
                .forEach(collaborator => {
                    const option = document.createElement('option');
                    option.value = collaborator.id;
                    option.textContent = `${collaborator.name} - ${collaborator.department} (${collaborator.baseSalary})`;
                    select.appendChild(option);
                });
            
            if (currentSelection && collaborators.some(c => c.id == currentSelection && c.active === true)) {
                select.value = currentSelection;
            }
        }
        
        function loadCollaboratorToCalculator(collaboratorId) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == collaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            if (collaborator.active !== true) {
                alert('Este colaborador está inativo. Selecione um colaborador ativo.');
                document.getElementById('collaboratorSelect').value = '';
                return;
            }
            
            document.getElementById('salarioBase').value = collaborator.baseSalary;
            document.getElementById('divisorMensal').value = collaborator.divisor;
            document.getElementById('usaPericulosidade').checked = collaborator.periculosidade;
            
            calcular();
        }
        
        function renderCollaboratorsTable(status = 'active') {
            const collaborators = getCollaborators();
            const container = document.getElementById('collaboratorsTableContainer');
            
            const filteredCollaborators = status === 'active' 
                ? collaborators.filter(c => c.active === true)
                : collaborators.filter(c => c.active === false);
            
            if (filteredCollaborators.length === 0) {
                const statusText = status === 'active' ? 'ativo' : 'inativo';
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-users fa-3x mb-4"></i>
                        <p class="text-lg">Nenhum colaborador ${statusText}.</p>
                        <p class="text-sm">${status === 'active' ? 'Clique em "Novo Colaborador" para cadastrar seu primeiro colaborador.' : 'Colaboradores inativados aparecerão aqui.'}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="overflow-x-auto">
                    <table class="collaborator-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Salário Base</th>
                                <th>Periculosidade</th>
                                ${status === 'inactive' ? '<th>Data Inativação</th>' : ''}
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filteredCollaborators.forEach(collaborator => {
                const inactivationDate = status === 'inactive' 
                    ? new Date(collaborator.updatedAt).toLocaleDateString('pt-BR')
                    : '';
                
                html += `
                    <tr data-id="${collaborator.id}">
                        <td class="font-medium">${collaborator.name}</td>
                        <td>${collaborator.department}</td>
                        <td>${collaborator.baseSalary}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs ${collaborator.periculosidade ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                ${collaborator.periculosidade ? 'Sim' : 'Não'}
                            </span>
                        </td>
                        ${status === 'inactive' ? `<td class="text-sm text-gray-600">${inactivationDate}</td>` : ''}
                        <td>
                            <div class="flex gap-2">
                                ${status === 'active' ? `
                                <button class="edit-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-edit mr-1"></i> Editar
                                </button>
                                <button class="view-collaborator-history text-purple-600 hover:text-purple-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-history mr-1"></i> Histórico
                                </button>
                                <button class="inactivate-collaborator text-red-600 hover:text-red-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-user-slash mr-1"></i> Inativar
                                </button>
                                ` : `
                                <button class="reactivate-collaborator text-green-600 hover:text-green-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-user-check mr-1"></i> Reativar
                                </button>
                                <button class="view-collaborator-history text-purple-600 hover:text-purple-800 text-sm" data-id="${collaborator.id}">
                                    <i class="fas fa-history mr-1"></i> Histórico
                                </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    Total: ${filteredCollaborators.length} colaborador(es) ${status === 'active' ? 'ativo(s)' : 'inativo(s)'}
                </div>
            `;
            
            container.innerHTML = html;
            
            updateStatusButtons(status);
            
            if (status === 'active') {
                document.querySelectorAll('.edit-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        editCollaborator(id);
                    });
                });
                
                document.querySelectorAll('.inactivate-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        inactivateCollaborator(id);
                    });
                });
            } else {
                document.querySelectorAll('.reactivate-collaborator').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        reactivateCollaborator(id);
                    });
                });
            }
            
            document.querySelectorAll('.view-collaborator-history').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showHistory();
                    document.getElementById('filterCollaborator').value = id;
                    applyHistoryFilters();
                });
            });
        }
        
        function updateStatusButtons(status) {
            const activeBtn = document.getElementById('showActiveCollaborators');
            const inactiveBtn = document.getElementById('showInactiveCollaborators');
            
            if (status === 'active') {
                activeBtn.classList.add('active');
                inactiveBtn.classList.remove('active');
            } else {
                activeBtn.classList.remove('active');
                inactiveBtn.classList.add('active');
            }
            
            currentCollaboratorStatus = status;
        }
        
        async function inactivateCollaborator(id) {
            if (!confirm('Tem certeza que deseja inativar este colaborador? Ele não aparecerá mais nas listas de seleção, mas os cálculos históricos serão mantidos.')) {
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorIndex = collaborators.findIndex(c => c.id === id);
            
            if (collaboratorIndex === -1) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            collaborators[collaboratorIndex].active = false;
            collaborators[collaboratorIndex].updatedAt = new Date().toISOString();
            
            await saveCollaborators(collaborators);
            
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador inativado com sucesso!');
        }
        
        async function reactivateCollaborator(id) {
            if (!confirm('Tem certeza que deseja reativar este colaborador?')) {
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorIndex = collaborators.findIndex(c => c.id === id);
            
            if (collaboratorIndex === -1) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            collaborators[collaboratorIndex].active = true;
            collaborators[collaboratorIndex].updatedAt = new Date().toISOString();
            
            await saveCollaborators(collaborators);
            
            updateCollaboratorSelect();
            renderCollaboratorsTable(currentCollaboratorStatus);
            updateCollaboratorFilterSelect();
            
            alert('Colaborador reativado com sucesso!');
        }
        
        function editCollaborator(id) {
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id === id);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            document.getElementById('collaboratorEditId').value = collaborator.id;
            document.getElementById('collaboratorName').value = collaborator.name;
            document.getElementById('collaboratorDepartment').value = collaborator.department;
            document.getElementById('collaboratorBaseSalary').value = collaborator.baseSalary;
            document.getElementById('collaboratorDivisor').value = collaborator.divisor;
            document.getElementById('collaboratorWorkHours').value = collaborator.workHours || '8';
            document.getElementById('collaboratorPericulosidade').checked = collaborator.periculosidade;
            document.getElementById('collaboratorInsalubridade').checked = collaborator.insalubridade;
            
            document.getElementById('collaboratorModalTitle').textContent = "Editar Colaborador";
            document.getElementById('collaboratorModalButton').textContent = "Atualizar Colaborador";
            
            openModal();
        }
        
        // ============================================
        // SISTEMA DE HISTÓRICO DE CÁLCULOS
        // ============================================
        
        async function saveCurrentCalculation() {
            const selectedCollaboratorId = document.getElementById('collaboratorSelect').value;
            
            if (!selectedCollaboratorId) {
                alert('Por favor, selecione um colaborador antes de salvar o cálculo.');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaborator = collaborators.find(c => c.id == selectedCollaboratorId);
            
            if (!collaborator) {
                alert('Colaborador não encontrado!');
                return;
            }
            
            const calculationData = {
                id: Date.now(),
                collaboratorId: selectedCollaboratorId,
                collaboratorName: collaborator.name,
                collaboratorDepartment: collaborator.department,
                collaboratorSalary: collaborator.baseSalary,
                timestamp: new Date().toLocaleString('pt-BR'),
                timestampISO: new Date().toISOString(),
                mesReferencia: document.getElementById('mesReferencia').value,
                data: {
                    salarioBase: document.getElementById('salarioBase').value,
                    divisorMensal: document.getElementById('divisorMensal').value,
                    usaPericulosidade: document.getElementById('usaPericulosidade').checked,
                    horasSobreavisoTotal: document.getElementById('horasSobreavisoTotal').value,
                    horasTrabalhadas50: document.getElementById('horasTrabalhadas50').value,
                    horasTrabalhadas100: document.getElementById('horasTrabalhadas100').value,
                    horasNoturnas: document.getElementById('horasNoturnas').value,
                    totalDiasNoMes: document.getElementById('totalDiasNoMes').value,
                    diasTrabalhados: document.getElementById('diasTrabalhados').value,
                    diasAtestado: document.getElementById('diasAtestado').value,
                    diasDomingo: document.getElementById('diasDomingo').value,
                    diasFeriado: document.getElementById('diasFeriado').value,
                    diasUteis: document.getElementById('diasUteis').value,
                    resultados: {
                        valorPericulosidade: document.getElementById('valorPericulosidade').textContent,
                        valorSobreavisoEspera: document.getElementById('valorSobreavisoEspera').textContent,
                        valorHoraExtraTrabalho50: document.getElementById('valorHoraExtraTrabalho50').textContent,
                        valorHoraExtraTrabalho100: document.getElementById('valorHoraExtraTrabalho100').textContent,
                        valorAdicionalNoturno: document.getElementById('valorAdicionalNoturno').textContent,
                        valorReflexoDSRTotalSum: document.getElementById('valorReflexoDSRTotalSum').textContent,
                        fatorDSR: document.getElementById('fatorDSRDisplay').textContent
                    }
                }
            };
            
            const calculations = getSavedCalculations();
            calculations.push(calculationData);
            
            await saveCalculations(calculations);
            
            alert(`Cálculo para ${collaborator.name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            if (document.getElementById('historyContent').classList.contains('hidden') === false) {
                renderHistoryTable();
            }
        }
        
        function renderHistoryTable(filters = {}) {
            const calculations = getSavedCalculations();
            const container = document.getElementById('historyTableBody');
            
            let filteredCalculations = [...calculations];
            
            if (filters.collaboratorId) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorId == filters.collaboratorId);
            }
            
            if (filters.department) {
                filteredCalculations = filteredCalculations.filter(c => c.collaboratorDepartment === filters.department);
            }
            
            if (filters.startMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia >= filters.startMonth);
            }
            
            if (filters.endMonth) {
                filteredCalculations = filteredCalculations.filter(c => c.mesReferencia <= filters.endMonth);
            }
            
            if (filters.searchText) {
                const searchLower = filters.searchText.toLowerCase();
                filteredCalculations = filteredCalculations.filter(c => 
                    c.collaboratorName.toLowerCase().includes(searchLower) ||
                    c.collaboratorDepartment.toLowerCase().includes(searchLower)
                );
            }
            
            filteredCalculations.sort((a, b) => new Date(b.timestampISO) - new Date(a.timestampISO));
            
            if (filteredCalculations.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-history fa-3x mb-4"></i>
                            <p class="text-lg">Nenhum cálculo encontrado.</p>
                            <p class="text-sm">${calculations.length === 0 ? 'Faça cálculos na aba "Calculadora" e salve-os para ver o histórico aqui.' : 'Tente ajustar os filtros.'}</p>
                        </td>
                    </tr>
                `;
                
                updateHistoryStats(filteredCalculations);
                return;
            }
            
            let html = '';
            
            filteredCalculations.forEach(calculation => {
                html += `
                    <tr>
                        <td>${calculation.mesReferencia}</td>
                        <td class="font-medium">${calculation.collaboratorName}</td>
                        <td>${calculation.collaboratorDepartment}</td>
                        <td class="text-sm text-gray-600">${calculation.timestamp}</td>
                        <td>
                            <span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800">
                                ${currentUser ? 'Sincronizado' : 'Local'}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="view-calculation-detail text-blue-600 hover:text-blue-800 text-sm" data-id="${calculation.id}" title="Ver detalhes">
                                    <i class="fas fa-eye"></i> Ver detalhes
                                </button>
                                <button class="delete-calculation text-red-600 hover:text-red-800 text-sm" data-id="${calculation.id}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            updateHistoryStats(filteredCalculations);
            addCalculationActionListeners();
        }
        
        function addCalculationActionListeners() {
            document.querySelectorAll('.view-calculation-detail').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    viewCalculationDetail(id);
                });
            });
            
            document.querySelectorAll('.delete-calculation').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteCalculation(id);
                });
            });
        }
        
        function updateHistoryStats(calculations) {
            const totalCalculations = calculations.length;
            
            const uniqueCollaboratorIds = [...new Set(calculations.map(c => c.collaboratorId))];
            const totalCollaboratorsWithHistory = uniqueCollaboratorIds.length;
            
            const uniqueMonths = [...new Set(calculations.map(c => c.mesReferencia))];
            const totalMonths = uniqueMonths.length;
            
            let totalReflexos = 0;
            let totalPericulosidade = 0;
            calculations.forEach(calc => {
                const valorReflexoDSRTotal = parseFloat(calc.data.resultados.valorReflexoDSRTotalSum.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                const valorPericulosidade = parseFloat(calc.data.resultados.valorPericulosidade.replace('R$', '').replace('.', '').replace(',', '.').trim()) || 0;
                totalReflexos += valorReflexoDSRTotal;
                totalPericulosidade += valorPericulosidade;
            });
            
            const totalGeral = totalReflexos + totalPericulosidade;
            
            document.getElementById('totalCalculations').textContent = totalCalculations;
            document.getElementById('totalCollaboratorsWithHistory').textContent = totalCollaboratorsWithHistory;
            document.getElementById('totalMonths').textContent = totalMonths;
            document.getElementById('totalReflexos').textContent = R$.format(totalReflexos);
        }
        
        function viewCalculationDetail(id) {
            const calculations = getSavedCalculations();
            const calculation = calculations.find(c => c.id === id);
            
            if (!calculation) {
                alert('Cálculo não encontrado!');
                return;
            }
            
            const detailContent = document.getElementById('calculationDetailContent');
            detailContent.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-lg titulo-cor mb-2">${calculation.collaboratorName}</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <span class="text-sm text-gray-600">Departamento:</span>
                                <p class="font-medium">${calculation.collaboratorDepartment}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Mês Referência:</span>
                                <p class="font-medium">${calculation.mesReferencia}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Data do Cálculo:</span>
                                <p class="font-medium">${calculation.timestamp}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Status:</span>
                                <p class="font-medium">${currentUser ? 'Sincronizado com a nuvem' : 'Salvo localmente'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h5 class="font-bold text-md titulo-cor mb-3">Dados de Entrada</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Salário Base:</span>
                                    <span class="font-medium">${calculation.data.salarioBase}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Divisor Mensal:</span>
                                    <span class="font-medium">${calculation.data.divisorMensal} horas</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Periculosidade:</span>
                                    <span class="font-medium">${calculation.data.usaPericulosidade ? 'Sim' : 'Não'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Dias Trabalhados:</span>
                                    <span class="font-medium">${calculation.data.diasTrabalhados}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Horas Sobreaviso:</span>
                                    <span class="font-medium">${calculation.data.horasSobreavisoTotal}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Horas Extras 50%:</span>
                                    <span class="font-medium">${calculation.data.horasTrabalhadas100}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Horas Noturnas:</span>
                                    <span class="font-medium">${calculation.data.horasNoturnas}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h5 class="font-bold text-md titulo-cor mb-3">Resultados</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm">Periculosidade (30%):</span>
                                    <span class="font-medium titulo-cor">${calculation.data.resultados.valorPericulosidade}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Horas Sobreaviso:</span>
                                    <span class="font-medium titulo-cor">${calculation.data.resultados.valorSobreavisoEspera}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Horas Extras 50%:</span>
                                    <span class="font-medium titulo-cor">${calculation.data.resultados.valorHoraExtraTrabalho100}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Adicional Noturno:</span>
                                    <span class="font-medium titulo-cor">${calculation.data.resultados.valorAdicionalNoturno}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm">Fator DSR:</span>
                                    <span class="font-medium">${calculation.data.resultados.fatorDSR}</span>
                                </div>
                                <div class="flex justify-between font-bold pt-2 border-t">
                                    <span>TOTAL REFLEXOS DSR:</span>
                                    <span class="titulo-cor">${calculation.data.resultados.valorReflexoDSRTotalSum}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h5 class="font-bold text-md titulo-cor mb-3">Resumo Financeiro</h5>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Adicionais</div>
                                <div class="text-xl font-bold titulo-cor">${calculation.data.resultados.valorPericulosidade}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Extras</div>
                                <div class="text-xl font-bold titulo-cor">${calculation.data.resultados.valorHoraExtraTrabalho100}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Noturno</div>
                                <div class="text-xl font-bold titulo-cor">${calculation.data.resultados.valorAdicionalNoturno}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-600">Reflexos DSR</div>
                                <div class="text-xl font-bold titulo-cor">${calculation.data.resultados.valorReflexoDSRTotalSum}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('calculationDetailTitle').textContent = `Detalhes do Cálculo - ${calculation.collaboratorName}`;
            openCalculationDetailModal();
        }
        
        async function deleteCalculation(id) {
            if (!confirm('Tem certeza que deseja excluir este cálculo do histórico?')) {
                return;
            }
            
            const calculations = getSavedCalculations();
            const filteredCalculations = calculations.filter(c => c.id !== id);
            
            await saveCalculations(filteredCalculations);
            renderHistoryTable();
            alert('Cálculo excluído do histórico com sucesso!');
        }
        
        function exportHistoryCSV() {
            const calculations = getSavedCalculations();
            
            if (calculations.length === 0) {
                alert('Não há cálculos para exportar!');
                return;
            }
            
            let csv = 'Mês Referência;Colaborador;Departamento;Salário Base;Periculosidade;Horas Sobreaviso;Horas Extras 50%;Adicional Noturno;Total Reflexos DSR;Fator DSR;Data do Cálculo\n';
            
            calculations.forEach(calc => {
                const row = [
                    calc.mesReferencia,
                    calc.collaboratorName,
                    calc.collaboratorDepartment,
                    calc.data.salarioBase,
                    calc.data.resultados.valorPericulosidade,
                    calc.data.horasSobreavisoTotal,
                    calc.data.resultados.valorHoraExtraTrabalho100,
                    calc.data.resultados.valorAdicionalNoturno,
                    calc.data.resultados.valorReflexoDSRTotalSum,
                    calc.data.resultados.fatorDSR,
                    calc.timestamp
                ].map(field => `"${field}"`).join(';');
                
                csv += row + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historico_calculos_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            alert('Histórico exportado como CSV com sucesso!');
        }
        
        function exportHistoryPDF() {
            const calculations = getSavedCalculations();
            
            if (calculations.length === 0) {
                alert('Não há cálculos para exportar!');
                return;
            }
            
            alert('Funcionalidade de exportação PDF será implementada em uma versão futura. Por enquanto, use a exportação CSV.');
        }
        
        function exportHistoryExcel() {
            const calculations = getSavedCalculations();
            
            if (calculations.length === 0) {
                alert('Não há cálculos para exportar!');
                return;
            }
            
            alert('Funcionalidade de exportação Excel será implementada em uma versão futura. Por enquanto, use a exportação CSV.');
        }
        
        // ============================================
        // FUNÇÕES DE DEPARTAMENTOS
        // ============================================
        
        async function saveNewDepartment(event) {
            event.preventDefault();
            
            const name = document.getElementById('departmentName').value.trim();
            const active = document.getElementById('departmentActive').checked;
            
            if (!name) {
                alert('Por favor, preencha o nome do departamento.');
                return;
            }
            
            const departments = getDepartments();
            const existingDepartment = departments.find(dept => 
                dept.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingDepartment && !window.editingDepartmentId) {
                alert(`Já existe um departamento com o nome "${name}".`);
                return;
            }
            
            let newDepartment;
            
            if (window.editingDepartmentId) {
                newDepartment = {
                    id: window.editingDepartmentId,
                    name: name,
                    active: active,
                    updatedAt: new Date().toISOString()
                };
                
                const originalDepartment = departments.find(dept => dept.id === window.editingDepartmentId);
                if (originalDepartment) {
                    newDepartment.createdAt = originalDepartment.createdAt;
                }
                
                const updatedDepartments = departments.map(dept => 
                    dept.id === window.editingDepartmentId ? newDepartment : dept
                );
                
                await saveDepartments(updatedDepartments);
                window.editingDepartmentId = null;
            } else {
                newDepartment = {
                    id: Date.now(),
                    name: name,
                    active: active,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                departments.push(newDepartment);
                await saveDepartments(departments);
            }
            
            closeDepartmentModal();
            updateDepartmentSelect();
            renderDepartmentsTable();
            
            alert(`Departamento ${name} salvo com sucesso! ${currentUser ? '(Sincronizado com a nuvem)' : ''}`);
            
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentModalTitle').textContent = "Cadastrar Novo Departamento";
            document.getElementById('departmentModalButton').textContent = "Salvar Departamento";
        }
        
        function editDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            document.getElementById('departmentName').value = department.name;
            document.getElementById('departmentActive').checked = department.active;
            
            document.getElementById('departmentModalTitle').textContent = "Editar Departamento";
            document.getElementById('departmentModalButton').textContent = "Atualizar Departamento";
            
            window.editingDepartmentId = id;
            
            openDepartmentModal();
        }
        
        async function deleteDepartment(id) {
            const departments = getDepartments();
            const department = departments.find(dept => dept.id === id);
            
            if (!department) {
                alert('Departamento não encontrado!');
                return;
            }
            
            const collaborators = getCollaborators();
            const collaboratorsInDepartment = collaborators.filter(collaborator => 
                collaborator.department === department.name && collaborator.active === true
            );
            
            let message = `Tem certeza que deseja excluir o departamento "${department.name}"?`;
            
            if (collaboratorsInDepartment.length > 0) {
                message += `\n\nATENÇÃO: Existem ${collaboratorsInDepartment.length} colaborador(es) ativo(s) vinculados a este departamento. Eles ficarão sem departamento atribuído.`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            const filteredDepartments = departments.filter(dept => dept.id !== id);
            
            if (collaboratorsInDepartment.length > 0) {
                const updatedCollaborators = collaborators.map(collaborator => {
                    if (collaborator.department === department.name) {
                        return { ...collaborator, department: '' };
                    }
                    return collaborator;
                });
                await saveCollaborators(updatedCollaborators);
            }
            
            await saveDepartments(filteredDepartments);
            
            updateDepartmentSelect();
            renderDepartmentsTable();
            updateCollaboratorFilterSelect();
            
            alert('Departamento excluído com sucesso!');
        }
        
        // ============================================
        // FUNÇÕES DE INTERFACE
        // ============================================
        
        function showCalculator() {
            document.getElementById('calculatorContent').classList.remove('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('departmentsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            
            document.getElementById('menuCalculator').classList.add('active');
            document.getElementById('menuCollaborators').classList.remove('active');
            document.getElementById('menuDepartments').classList.remove('active');
            document.getElementById('menuHistory').classList.remove('active');
        }
        
        function showCollaborators() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.remove('hidden');
            document.getElementById('departmentsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            
            document.getElementById('menuCalculator').classList.remove('active');
            document.getElementById('menuCollaborators').classList.add('active');
            document.getElementById('menuDepartments').classList.remove('active');
            document.getElementById('menuHistory').classList.remove('active');
            
            renderCollaboratorsTable('active');
        }
        
        function showDepartments() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('departmentsContent').classList.remove('hidden');
            document.getElementById('historyContent').classList.add('hidden');
            
            document.getElementById('menuCalculator').classList.remove('active');
            document.getElementById('menuCollaborators').classList.remove('active');
            document.getElementById('menuDepartments').classList.add('active');
            document.getElementById('menuHistory').classList.remove('active');
            
            renderDepartmentsTable();
        }
        
        function showHistory() {
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('collaboratorsContent').classList.add('hidden');
            document.getElementById('departmentsContent').classList.add('hidden');
            document.getElementById('historyContent').classList.remove('hidden');
            
            document.getElementById('menuCalculator').classList.remove('active');
            document.getElementById('menuCollaborators').classList.remove('active');
            document.getElementById('menuDepartments').classList.remove('active');
            document.getElementById('menuHistory').classList.add('active');
            
            renderHistoryTable();
            updateCollaboratorFilterSelect();
        }
        
        // Funções para modal de colaborador
        function openModal() {
            document.getElementById('collaboratorModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('collaboratorModal').classList.remove('active');
            resetCollaboratorForm();
        }
        
        // Funções para modal de departamento
        function openDepartmentModal() {
            document.getElementById('departmentModal').classList.add('active');
        }
        
        function closeDepartmentModal() {
            document.getElementById('departmentModal').classList.remove('active');
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentModalTitle').textContent = "Cadastrar Novo Departamento";
            document.getElementById('departmentModalButton').textContent = "Salvar Departamento";
            
            window.editingDepartmentId = null;
        }
        
        // Funções para modal de detalhes do cálculo
        function openCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.add('active');
        }
        
        function closeCalculationDetailModal() {
            document.getElementById('calculationDetailModal').classList.remove('active');
        }
        
        // Função para aplicar filtros no histórico
        function applyHistoryFilters() {
            const filters = {
                collaboratorId: document.getElementById('filterCollaborator').value,
                department: document.getElementById('filterDepartment').value,
                startMonth: document.getElementById('filterStartMonth').value,
                endMonth: document.getElementById('filterEndMonth').value,
                searchText: document.getElementById('searchCollaborator').value
            };
            
            renderHistoryTable(filters);
        }
        
        // Função para limpar filtros do histórico
        function clearHistoryFilters() {
            document.getElementById('filterCollaborator').value = '';
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterStartMonth').value = '';
            document.getElementById('filterEndMonth').value = '';
            document.getElementById('searchCollaborator').value = '';
            
            renderHistoryTable();
        }
        
        // Função para alternar visibilidade das bases de cálculo
        function toggleBasesVisibility() {
            const basesContainer = document.getElementById('basesContainer');
            const basesIcon = document.getElementById('basesIcon');
            
            if (basesContainer.classList.contains('hidden')) {
                basesContainer.classList.remove('hidden');
                basesIcon.classList.remove('fa-chevron-down');
                basesIcon.classList.add('fa-chevron-up');
            } else {
                basesContainer.classList.add('hidden');
                basesIcon.classList.remove('fa-chevron-up');
                basesIcon.classList.add('fa-chevron-down');
            }
        }
        
        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar elementos da calculadora
            const monthInput = document.getElementById('mesReferencia');
            const salarioBaseInput = document.getElementById('salarioBase');
            
            // Definir o mês atual como padrão
            monthInput.value = getCurrentMonthString();
            
            // Inicializar os dias DSR e úteis
            handleMonthChange(true);
            
            // Inicializar departamentos
            getDepartments();
            
            // Atualizar seletor de departamentos e colaboradores
            updateDepartmentSelect();
            updateCollaboratorSelect();
            updateCollaboratorFilterSelect();
            
            // Adicionar listeners de input para recalcular
            const inputsAndSelects = document.querySelectorAll('#calculatorContent input:not([readonly]):not(#mesReferencia):not(#salarioBase), #calculatorContent select');
            inputsAndSelects.forEach(element => element.addEventListener('input', calcular));
            inputsAndSelects.forEach(element => element.addEventListener('change', calcular));
            
            // Listener específico para o Salário Base
            salarioBaseInput.addEventListener('input', () => {
                formatCurrencyInput(salarioBaseInput);
                calcular();
            });

            // Listener específico para mudança do mês
            monthInput.addEventListener('change', () => handleMonthChange(false));
            
            // Listeners adicionais
            document.getElementById('diasFeriado').addEventListener('input', calcular);
            document.getElementById('diasTrabalhados').addEventListener('input', () => {
                const monthInput = document.getElementById('mesReferencia').value;
                if (monthInput) {
                    const [year, month] = monthInput.split('-').map(Number);
                    updateHolidaysDisplay(year);
                }
                calcular();
            });
            document.getElementById('diasAtestado').addEventListener('input', calcular); 
            document.getElementById('usaPericulosidade').addEventListener('change', calcular); 
            
            // Listener para o botão LIMPAR
            document.getElementById('clearButton').addEventListener('click', resetInputs);

            // Listener para o botão de impressão
            document.getElementById('printButton').addEventListener('click', () => {
                window.print();
            });
            
            // Listener para o botão SALVAR CÁLCULO
            document.getElementById('saveCalculation').addEventListener('click', saveCurrentCalculation);
            
            // Listener para atualizar lista de colaboradores
            document.getElementById('refreshCollaborators').addEventListener('click', () => {
                updateCollaboratorSelect();
                updateCollaboratorFilterSelect();
            });
            
            // Listener para selecionar colaborador
            document.getElementById('collaboratorSelect').addEventListener('change', function() {
                if (this.value) {
                    loadCollaboratorToCalculator(this.value);
                }
            });
            
            // Listener para atualizar lista na página de colaboradores
            document.getElementById('refreshCollaboratorList').addEventListener('click', () => {
                renderCollaboratorsTable(currentCollaboratorStatus);
            });
            
            // Listener para mostrar colaboradores ativos
            document.getElementById('showActiveCollaborators').addEventListener('click', () => {
                renderCollaboratorsTable('active');
            });
            
            // Listener para mostrar colaboradores inativos
            document.getElementById('showInactiveCollaborators').addEventListener('click', () => {
                renderCollaboratorsTable('inactive');
            });
            
            // Listener para atualizar lista na página de departamentos
            document.getElementById('refreshDepartments').addEventListener('click', renderDepartmentsTable);
            
            // Listener para atualizar histórico
            document.getElementById('refreshHistory').addEventListener('click', () => {
                renderHistoryTable();
                updateCollaboratorFilterSelect();
            });
            
            // Listener para busca de colaboradores no histórico
            document.getElementById('searchCollaborator').addEventListener('input', function() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    applyHistoryFilters();
                }, 300);
            });
            
            // Listener para limpar filtros do histórico
            document.getElementById('clearHistoryFilters').addEventListener('click', clearHistoryFilters);
            
            // Listener para aplicar filtros do histórico
            document.getElementById('applyFilters').addEventListener('click', applyHistoryFilters);
            
            // Listener para alternar bases de cálculo
            document.getElementById('toggleBases').addEventListener('click', toggleBasesVisibility);
            
            // Menu navigation
            document.getElementById('menuCalculator').addEventListener('click', showCalculator);
            document.getElementById('menuCollaborators').addEventListener('click', showCollaborators);
            document.getElementById('menuDepartments').addEventListener('click', showDepartments);
            document.getElementById('menuHistory').addEventListener('click', showHistory);
            
            // Modal handlers - Colaborador
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelCollaborator').addEventListener('click', closeModal);
            document.getElementById('collaboratorForm').addEventListener('submit', saveCollaborator);
            document.getElementById('addNewCollaborator').addEventListener('click', () => {
                resetCollaboratorForm();
                openModal();
            });
            
            // Modal handlers - Departamento
            document.getElementById('closeDepartmentModal').addEventListener('click', closeDepartmentModal);
            document.getElementById('cancelDepartment').addEventListener('click', closeDepartmentModal);
            document.getElementById('departmentForm').addEventListener('submit', saveNewDepartment);
            document.getElementById('addNewDepartment').addEventListener('click', openDepartmentModal);
            
            // Modal handlers - Detalhes do cálculo
            document.getElementById('closeCalculationDetailModal').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('closeCalculationDetail').addEventListener('click', closeCalculationDetailModal);
            document.getElementById('printCalculationDetail').addEventListener('click', () => {
                window.print();
            });
            
            // Exportação do histórico
            document.getElementById('exportHistoryCSV').addEventListener('click', exportHistoryCSV);
            document.getElementById('exportHistoryPDF').addEventListener('click', exportHistoryPDF);
            document.getElementById('exportHistoryExcel').addEventListener('click', exportHistoryExcel);
            
            // Formatação de moeda nos modais
            document.getElementById('collaboratorBaseSalary').addEventListener('input', function() {
                formatCurrencyInput(this);
            });
            
            // Fechar modais ao clicar fora
            document.getElementById('collaboratorModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('departmentModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDepartmentModal();
                }
            });
            
            document.getElementById('calculationDetailModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeCalculationDetailModal();
                }
            });
            
            // Calcular inicialmente
            calcular();
            
            // Atualizar status inicial do Firebase
            updateFirebaseStatus('loading', 'Conectando ao Firebase...');
        });
    </script>

</body>
</html>